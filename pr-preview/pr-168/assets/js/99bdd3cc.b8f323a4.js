"use strict";(globalThis.webpackChunk_ethdebug_format_web=globalThis.webpackChunk_ethdebug_format_web||[]).push([[1990],{792(e,t,n){n.d(t,{A:()=>d});n(14041);var s=n(40665);const r="container_Hrln",a="link_y57m",i="label_feh8",o="schema_kJnE",l="arrow_YbSg";var c=n(31085);function d({schema:e,href:t}){return(0,c.jsx)("div",{className:r,children:(0,c.jsxs)(s.A,{to:t,className:a,children:[(0,c.jsx)("span",{className:i,children:"Schema:"}),(0,c.jsx)("span",{className:o,children:e}),(0,c.jsx)("span",{className:l,children:"\u2192"})]})})}},6690(e,t,n){n.r(t),n.d(t,{assets:()=>d,contentTitle:()=>c,default:()=>m,frontMatter:()=>l,metadata:()=>s,toc:()=>u});const s=JSON.parse('{"id":"core-schemas/pointers/regions","title":"Regions","description":"A region represents a contiguous block of bytes in a specific EVM data","source":"@site/docs/core-schemas/pointers/regions.mdx","sourceDirName":"core-schemas/pointers","slug":"/core-schemas/pointers/regions","permalink":"/format/pr-preview/pr-168/docs/core-schemas/pointers/regions","draft":false,"unlisted":false,"editUrl":"https://github.com/ethdebug/format/tree/main/packages/web/docs/core-schemas/pointers/regions.mdx","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"docsSidebar","previous":{"title":"Pointers","permalink":"/format/pr-preview/pr-168/docs/core-schemas/pointers/"},"next":{"title":"Expressions","permalink":"/format/pr-preview/pr-168/docs/core-schemas/pointers/expressions"}}');var r=n(31085),a=n(71184),i=n(792),o=n(38532);const l={sidebar_position:2},c="Regions",d={},u=[{value:"Addressing schemes",id:"addressing-schemes",level:2},{value:"Slice-based locations",id:"slice-based-locations",level:3},{value:"Slot-based locations",id:"slot-based-locations",level:3},{value:"Location-specific details",id:"location-specific-details",level:2},{value:"Memory",id:"memory",level:3},{value:"Storage",id:"storage",level:3},{value:"Stack",id:"stack",level:3},{value:"Calldata",id:"calldata",level:3},{value:"Returndata",id:"returndata",level:3},{value:"Code",id:"code",level:3},{value:"Transient storage",id:"transient-storage",level:3},{value:"Naming regions",id:"naming-regions",level:2},{value:"Dynamic addresses",id:"dynamic-addresses",level:2},{value:"Learn more",id:"learn-more",level:2}];function h(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"regions",children:"Regions"})}),"\n",(0,r.jsx)(i.A,{schema:"ethdebug/format/pointer/region",href:"/spec/pointer/region"}),"\n",(0,r.jsxs)(o.rM,{children:[(0,r.jsx)(t.p,{children:"A region represents a contiguous block of bytes in a specific EVM data\nlocation. Regions are the leaves of the pointer tree\u2014the actual byte ranges\nthat hold data."}),(0,r.jsx)(t.h2,{id:"addressing-schemes",children:"Addressing schemes"}),(0,r.jsx)(t.p,{children:"The EVM uses two different models for organizing bytes, and regions reflect\nthis:"}),(0,r.jsx)(t.h3,{id:"slice-based-locations",children:"Slice-based locations"}),(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Memory"}),", ",(0,r.jsx)(t.strong,{children:"calldata"}),", ",(0,r.jsx)(t.strong,{children:"returndata"}),", and ",(0,r.jsx)(t.strong,{children:"code"})," are byte-addressable.\nRegions in these locations use ",(0,r.jsx)(t.code,{children:"offset"})," and ",(0,r.jsx)(t.code,{children:"length"}),":"]}),(0,r.jsx)(o.C,{title:"Memory region (slice-based)",pointer:{location:"memory",offset:"0x40",length:32},state:{memory:"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080"},description:"Reads 32 bytes starting at offset 0x40 (the free memory pointer)"}),(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"offset"}),": byte position from the start (required)"]}),"\n",(0,r.jsxs)(t.li,{children:[(0,r.jsx)(t.code,{children:"length"}),": number of bytes (required)"]}),"\n"]}),(0,r.jsx)(t.h3,{id:"slot-based-locations",children:"Slot-based locations"}),(0,r.jsxs)(t.p,{children:[(0,r.jsx)(t.strong,{children:"Storage"}),", ",(0,r.jsx)(t.strong,{children:"transient storage"}),", and ",(0,r.jsx)(t.strong,{children:"stack"})," are organized in 32-byte\nslots. Regions use ",(0,r.jsx)(t.code,{children:"slot"}),":"]}),(0,r.jsx)(o.C,{title:"Storage slot (slot-based)",pointer:{location:"storage",slot:5},state:{storage:{"0x05":"0x00000000000000000000000000000000000000000000000000000000000003e8"}},description:"Reads the full 32-byte word at storage slot 5"}),(0,r.jsx)(t.p,{children:"For storage and transient storage, values that don't fill a full slot can\nspecify sub-slot positioning:"}),(0,r.jsx)(o.C,{title:"Packed storage (sub-slot)",pointer:{location:"storage",slot:0,offset:12,length:20},state:{storage:{"0x00":"0x000000000000000000000000d8da6bf26964af9d7eed9e03e53415d37aa96045"}},description:"Reads 20 bytes at offset 12 within slot 0 (an address in packed storage)"}),(0,r.jsx)(t.p,{children:"This addresses 20 bytes starting at byte 12 within slot 0\u2014useful for packed\nstorage."}),(0,r.jsx)(t.h2,{id:"location-specific-details",children:"Location-specific details"}),(0,r.jsx)(t.h3,{id:"memory",children:"Memory"}),(0,r.jsx)(t.p,{children:"Memory is a simple byte array that grows as needed:"}),(0,r.jsx)(o.C,{title:"Memory region",pointer:{location:"memory",offset:"0x80",length:64},state:{memory:"0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000048656c6c6f20576f726c642100"},description:"Reads 64 bytes starting at offset 0x80"}),(0,r.jsxs)(t.p,{children:["Memory addresses often come from the free memory pointer (stored at ",(0,r.jsx)(t.code,{children:"0x40"}),")."]}),(0,r.jsx)(t.h3,{id:"storage",children:"Storage"}),(0,r.jsx)(t.p,{children:"Storage persists between transactions. Slots are 32-byte words addressed by\n256-bit keys:"}),(0,r.jsx)(o.C,{title:"Storage slot",pointer:{location:"storage",slot:"0x0000000000000000000000000000000000000000000000000000000000000000"},state:{storage:{"0x00":"0x000000000000000000000000000000000000000000000000000000000000002a"}},description:"Reads storage slot 0 (full 256-bit key)"}),(0,r.jsx)(t.p,{children:"Slot addresses can be literal numbers, hex strings, or computed expressions."}),(0,r.jsx)(t.h3,{id:"stack",children:"Stack"}),(0,r.jsx)(t.p,{children:"The EVM stack holds up to 1024 words. Slot 0 is the top:"}),(0,r.jsx)(o.C,{title:"Stack position",pointer:{location:"stack",slot:0},state:{stack:["0x0000000000000000000000000000000000000000000000000000000000000001","0x0000000000000000000000000000000000000000000000000000000000000002"]},description:"Reads the top of the stack (slot 0)"}),(0,r.jsx)(t.p,{children:"Stack regions are typically read-only from a debugging perspective\u2014you observe\nvalues but don't address sub-ranges."}),(0,r.jsx)(t.h3,{id:"calldata",children:"Calldata"}),(0,r.jsx)(t.p,{children:"Function arguments arrive in calldata, read-only and byte-addressable:"}),(0,r.jsx)(o.C,{title:"Calldata region",pointer:{location:"calldata",offset:4,length:32},state:{calldata:"0xa9059cbb000000000000000000000000d8da6bf26964af9d7eed9e03e53415d37aa960450000000000000000000000000000000000000000000000000de0b6b3a7640000"},description:"Reads first argument (32 bytes after 4-byte selector)"}),(0,r.jsx)(t.p,{children:"The first 4 bytes are typically the function selector; arguments follow."}),(0,r.jsx)(t.h3,{id:"returndata",children:"Returndata"}),(0,r.jsx)(t.p,{children:"After a call, the returned data is accessible:"}),(0,r.jsx)(o.C,{title:"Returndata region",pointer:{location:"returndata",offset:0,length:32},state:{returndata:"0x0000000000000000000000000000000000000000000000000000000000000001"},description:"Reads first 32 bytes of return data"}),(0,r.jsx)(t.h3,{id:"code",children:"Code"}),(0,r.jsx)(t.p,{children:"Contract bytecode can be read as data:"}),(0,r.jsx)(o.C,{title:"Code region",pointer:{location:"code",offset:100,length:32},state:{code:"0x608060405234801561001057600080fd5b506004361061002b5760003560e01c806360fe47b1146100305780636d4ce63c1461004c575b600080fd5b61004a60048036038101906100459190610"},description:"Reads 32 bytes from bytecode at offset 100"}),(0,r.jsx)(t.p,{children:"This is used for immutable variables and other data embedded in bytecode."}),(0,r.jsx)(t.h3,{id:"transient-storage",children:"Transient storage"}),(0,r.jsx)(t.p,{children:"Transient storage (EIP-1153) persists only within a transaction:"}),(0,r.jsx)(o.C,{title:"Transient storage",pointer:{location:"transient",slot:0},state:{transient:{"0x00":"0x0000000000000000000000000000000000000000000000000000000000000001"}},description:"Reads transient storage slot 0"}),(0,r.jsx)(t.p,{children:"Uses the same slot-based addressing as regular storage."}),(0,r.jsx)(t.h2,{id:"naming-regions",children:"Naming regions"}),(0,r.jsxs)(t.p,{children:["Any region can have a ",(0,r.jsx)(t.code,{children:"name"})," that other parts of the pointer reference:"]}),(0,r.jsx)(o.C,{title:"Named region",pointer:{name:"token-balance",location:"storage",slot:3},state:{storage:{"0x03":"0x00000000000000000000000000000000000000000000000000000000000003e8"}},description:"Named region 'token-balance' at storage slot 3"}),(0,r.jsx)(t.p,{children:"Names enable:"}),(0,r.jsxs)(t.ul,{children:["\n",(0,r.jsxs)(t.li,{children:["Reading the region's value with ",(0,r.jsx)(t.code,{children:'{ "$read": "token-balance" }'})]}),"\n",(0,r.jsxs)(t.li,{children:["Referencing properties with ",(0,r.jsx)(t.code,{children:'{ ".slot": "token-balance" }'})]}),"\n",(0,r.jsx)(t.li,{children:"Building self-documenting pointer structures"}),"\n"]}),(0,r.jsx)(t.h2,{id:"dynamic-addresses",children:"Dynamic addresses"}),(0,r.jsxs)(t.p,{children:["Region fields like ",(0,r.jsx)(t.code,{children:"offset"}),", ",(0,r.jsx)(t.code,{children:"slot"}),", and ",(0,r.jsx)(t.code,{children:"length"})," can use expressions to\ncompute values at runtime. This enables pointers for dynamic data like arrays\nand mappings."]}),(0,r.jsxs)(t.p,{children:["For the full expression language including arithmetic, ",(0,r.jsx)(t.code,{children:"$keccak256"}),", and value\nreading, see ",(0,r.jsx)(t.a,{href:"./expressions",children:"expressions"}),"."]}),(0,r.jsx)(t.h2,{id:"learn-more",children:"Learn more"}),(0,r.jsxs)(t.p,{children:["For complete schemas for each location type, see the\n",(0,r.jsx)(t.a,{href:"/spec/pointer/region",children:"pointer region specification"}),"."]})]})]})}function m(e={}){const{wrapper:t}={...(0,a.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},38532(e,t,n){n.d(t,{C:()=>P,rM:()=>U});var s=n(31085),r=n(14041),a=n(70396);function i(e){return e.toHex()}function o(e={}){const{initialPointer:t=null,initialStateSpec:n={},autoResolve:s=!0}=e,[i,o]=(0,r.useState)(t),[l,c]=(0,r.useState)(n),[d,u]=(0,r.useState)(!1),[h,m]=(0,r.useState)(null),[g,p]=(0,r.useState)(null),f=(0,r.useCallback)(((e,t)=>{c((n=>({...n,[e]:t})))}),[]),x=(0,r.useCallback)((async()=>{if(!i)return m(null),void p(null);u(!0),p(null);try{const e=function(e){const t=(e.stack||[]).map((e=>"string"==typeof e?a.B.fromHex(e).padUntilAtLeast(32):a.B.fromUint(e).padUntilAtLeast(32))),n=e.memory?a.B.fromHex(e.memory):a.B.zero(),s=new Map;for(const[c,d]of Object.entries(e.storage||{})){const e=a.B.fromHex(c).padUntilAtLeast(32).toHex();s.set(e,a.B.fromHex(d).padUntilAtLeast(32))}const r=e.calldata?a.B.fromHex(e.calldata):a.B.zero(),i=e.returndata?a.B.fromHex(e.returndata):a.B.zero(),o=e.code?a.B.fromHex(e.code):a.B.zero(),l=new Map;for(const[c,d]of Object.entries(e.transient||{})){const e=a.B.fromHex(c).padUntilAtLeast(32).toHex();l.set(e,a.B.fromHex(d).padUntilAtLeast(32))}return{get traceIndex(){return Promise.resolve(e.traceIndex??0n)},get programCounter(){return Promise.resolve(e.programCounter??0n)},get opcode(){return Promise.resolve(e.opcode??"STOP")},stack:{get length(){return Promise.resolve(BigInt(t.length))},async peek({depth:e,slice:n}){const s=Number(e);if(s>=t.length)throw new Error(`Stack underflow: depth ${e} exceeds stack size`);const r=t[s];if(!n)return r;const{offset:i,length:o}=n,l=32-Number(i)-Number(o),c=l+Number(o);return a.B.fromBytes(r.slice(l,c))}},memory:{get length(){return Promise.resolve(BigInt(n.length))},async read({slice:e}){const{offset:t,length:s}=e,r=Number(t),i=r+Number(s);if(i>n.length){const e=new Uint8Array(Number(s)),t=Math.max(0,n.length-r);return t>0&&r<n.length&&e.set(n.slice(r,r+t),0),a.B.fromBytes(e)}return a.B.fromBytes(n.slice(r,i))}},storage:{async read({slot:e,slice:t}){const n=e.padUntilAtLeast(32).toHex(),r=s.get(n)||a.B.zero().padUntilAtLeast(32);if(!t)return r;const{offset:i,length:o}=t,l=32-Number(i)-Number(o),c=l+Number(o);return a.B.fromBytes(r.slice(l,c))}},calldata:{get length(){return Promise.resolve(BigInt(r.length))},async read({slice:e}){const{offset:t,length:n}=e,s=Number(t),i=s+Number(n);if(i>r.length){const e=new Uint8Array(Number(n)),t=Math.max(0,r.length-s);return t>0&&s<r.length&&e.set(r.slice(s,s+t),0),a.B.fromBytes(e)}return a.B.fromBytes(r.slice(s,i))}},returndata:{get length(){return Promise.resolve(BigInt(i.length))},async read({slice:e}){const{offset:t,length:n}=e,s=Number(t),r=s+Number(n);if(r>i.length){const e=new Uint8Array(Number(n)),t=Math.max(0,i.length-s);return t>0&&s<i.length&&e.set(i.slice(s,s+t),0),a.B.fromBytes(e)}return a.B.fromBytes(i.slice(s,r))}},code:{get length(){return Promise.resolve(BigInt(o.length))},async read({slice:e}){const{offset:t,length:n}=e,s=Number(t),r=s+Number(n);if(r>o.length){const e=new Uint8Array(Number(n)),t=Math.max(0,o.length-s);return t>0&&s<o.length&&e.set(o.slice(s,s+t),0),a.B.fromBytes(e)}return a.B.fromBytes(o.slice(s,r))}},transient:{async read({slot:e,slice:t}){const n=e.padUntilAtLeast(32).toHex(),s=l.get(n)||a.B.zero().padUntilAtLeast(32);if(!t)return s;const{offset:r,length:i}=t,o=32-Number(r)-Number(i),c=o+Number(i);return a.B.fromBytes(s.slice(o,c))}}}}(l),t=await(0,a.D)(i,{state:e}),n=await t.view(e),s=new Map;for(const a of n.regions)try{const e=await n.read(a);s.set(a,e)}catch{}const r={};for(const a of n.regions)"name"in a&&"string"==typeof a.name&&(r[a.name]||(r[a.name]=[]),r[a.name].push(a));const o={};for(const[a,i]of Object.entries(r))i.length>0&&(o[a]=i[i.length-1]);m({regions:[...n.regions],values:s,namedRegions:r,lookup:o})}catch(e){p(e instanceof Error?e:new Error(String(e))),m(null)}finally{u(!1)}}),[i,l]),v=(0,r.useCallback)((()=>{o(t),c(n),m(null),p(null)}),[t,n]);return(0,r.useEffect)((()=>{s&&x()}),[s,x]),{pointer:i,stateSpec:l,isResolving:d,result:h,error:g,setPointer:o,setStateSpec:c,updateStateSpec:f,resolve:x,reset:v}}const l=(0,r.createContext)(void 0);function c(){const e=(0,r.useContext)(l);if(void 0===e)throw new Error("usePointerResolverContext must be used within a PointerResolverProvider");return e}function d({children:e,...t}){const n=o(t);return(0,s.jsx)(l.Provider,{value:n,children:e})}function u(e){return"location"in e&&"string"==typeof e.location?e.location:"unknown"}function h(e){const t=[u(e)];if("slot"in e&&void 0!==e.slot){const n=i(e.slot);t.push(`slot: ${n}`)}if("offset"in e&&void 0!==e.offset){const n=i(e.offset);t.push(`offset: ${n}`)}if("length"in e&&void 0!==e.length){const n=i(e.length);t.push(`length: ${n}`)}return t.join(", ")}function m({regions:e,selectedName:t,onRegionClick:n}){const r=Object.keys(e).sort();return 0===r.length?(0,s.jsx)("div",{className:"region-map region-map-empty",children:(0,s.jsx)("span",{className:"region-map-empty-text",children:"No named regions"})}):(0,s.jsx)("div",{className:"region-map",children:r.map((r=>{const a=e[r],i=r===t;return(0,s.jsxs)("div",{className:"region-map-entry "+(i?"selected":""),children:[(0,s.jsx)("div",{className:"region-map-name",children:r}),(0,s.jsx)("div",{className:"region-map-regions",children:a.map(((e,t)=>{const a=u(e),i=function(e){return{storage:"region-storage",memory:"region-memory",stack:"region-stack",calldata:"region-calldata",returndata:"region-returndata",code:"region-code",transient:"region-transient"}[e]||"region-unknown"}(a);return(0,s.jsxs)("div",{className:`region-map-region ${i}`,onClick:()=>n?.(r,e),role:"button",tabIndex:0,onKeyDown:t=>{"Enter"!==t.key&&" "!==t.key||n?.(r,e)},children:[(0,s.jsx)("span",{className:"region-location-badge",children:a}),(0,s.jsx)("span",{className:"region-details",children:h(e)})]},t)}))})]},r)}))})}function g({region:e,value:t,showFullValues:n,index:r}){const a=function(e){return"location"in e&&"string"==typeof e.location?e.location:"unknown"}(e),o=function(e){return{storage:"region-storage",memory:"region-memory",stack:"region-stack",calldata:"region-calldata",returndata:"region-returndata",code:"region-code",transient:"region-transient"}[e]||"region-unknown"}(a),l="name"in e?e.name:void 0,c=t?n?i(t):function(e,t=10){const n=e.toHex();if(n.length<=t+2)return n;const s=Math.floor((t-2)/2),r=t-2-s;return`${n.slice(0,2+s)}...${n.slice(-r)}`}(t,16):"(no value)";return(0,s.jsxs)("div",{className:`region-output-item ${o}`,children:[(0,s.jsxs)("div",{className:"region-output-header",children:[(0,s.jsxs)("span",{className:"region-output-index",children:["#",r+1]}),(0,s.jsx)("span",{className:"region-location-badge",children:a}),l&&(0,s.jsx)("span",{className:"region-name-badge",children:l})]}),(0,s.jsxs)("div",{className:"region-output-details",children:["slot"in e&&void 0!==e.slot&&(0,s.jsxs)("div",{className:"region-output-field",children:[(0,s.jsx)("span",{className:"region-field-label",children:"slot:"}),(0,s.jsx)("code",{className:"region-field-value",children:i(e.slot)})]}),"offset"in e&&void 0!==e.offset&&(0,s.jsxs)("div",{className:"region-output-field",children:[(0,s.jsx)("span",{className:"region-field-label",children:"offset:"}),(0,s.jsx)("code",{className:"region-field-value",children:i(e.offset)})]}),"length"in e&&void 0!==e.length&&(0,s.jsxs)("div",{className:"region-output-field",children:[(0,s.jsx)("span",{className:"region-field-label",children:"length:"}),(0,s.jsx)("code",{className:"region-field-value",children:i(e.length)})]})]}),(0,s.jsxs)("div",{className:"region-output-value",children:[(0,s.jsx)("span",{className:"region-value-label",children:"value:"}),(0,s.jsx)("code",{className:"region-value-data "+(t?"":"no-value"),title:t?i(t):void 0,children:c})]})]})}function p({regions:e,values:t,showFullValues:n=!1}){return 0===e.length?(0,s.jsx)("div",{className:"region-output region-output-empty",children:(0,s.jsx)("span",{className:"region-output-empty-text",children:"No regions resolved"})}):(0,s.jsxs)("div",{className:"region-output",children:[(0,s.jsxs)("div",{className:"region-output-summary",children:[e.length," region",1!==e.length?"s":""," resolved"]}),(0,s.jsx)("div",{className:"region-output-list",children:e.map(((e,r)=>(0,s.jsx)(g,{region:e,value:t.get(e),showFullValues:n,index:r},r)))})]})}function f({storage:e,onChange:t}){const n=Object.entries(e);return(0,s.jsxs)("div",{className:"state-editor-section",children:[(0,s.jsxs)("div",{className:"state-editor-header",children:[(0,s.jsx)("span",{children:"Storage"}),(0,s.jsx)("button",{className:"state-editor-add-btn",onClick:()=>{const s=`0x${n.length.toString(16).padStart(2,"0")}`;t({...e,[s]:"0x00"})},type:"button",children:"+ Add"})]}),0===n.length?(0,s.jsx)("div",{className:"state-editor-empty",children:"No storage entries"}):(0,s.jsx)("div",{className:"state-editor-entries",children:n.map((([n,r])=>(0,s.jsxs)("div",{className:"state-editor-entry",children:[(0,s.jsx)("input",{className:"state-editor-input slot",value:n,onChange:s=>((n,s)=>{const r={...e},a=r[n];delete r[n],s&&(r[s]=a),t(r)})(n,s.target.value),placeholder:"slot (hex)"}),(0,s.jsx)("span",{className:"state-editor-arrow",children:"="}),(0,s.jsx)("input",{className:"state-editor-input value",value:r,onChange:s=>((n,s)=>{t({...e,[n]:s})})(n,s.target.value),placeholder:"value (hex)"}),(0,s.jsx)("button",{className:"state-editor-remove-btn",onClick:()=>(n=>{const s={...e};delete s[n],t(s)})(n),type:"button","aria-label":"Remove entry",children:"\xd7"})]},n)))})]})}function x({stack:e,onChange:t}){return(0,s.jsxs)("div",{className:"state-editor-section",children:[(0,s.jsxs)("div",{className:"state-editor-header",children:[(0,s.jsx)("span",{children:"Stack (top first)"}),(0,s.jsx)("button",{className:"state-editor-add-btn",onClick:()=>{t([...e,"0x00"])},type:"button",children:"+ Add"})]}),0===e.length?(0,s.jsx)("div",{className:"state-editor-empty",children:"Empty stack"}):(0,s.jsx)("div",{className:"state-editor-entries",children:e.map(((n,r)=>(0,s.jsxs)("div",{className:"state-editor-entry",children:[(0,s.jsxs)("span",{className:"state-editor-index",children:["[",r,"]"]}),(0,s.jsx)("input",{className:"state-editor-input value",value:"bigint"==typeof n?`0x${n.toString(16)}`:n,onChange:n=>((n,s)=>{const r=[...e];r[n]=s,t(r)})(r,n.target.value),placeholder:"value (hex)"}),(0,s.jsx)("button",{className:"state-editor-remove-btn",onClick:()=>(n=>{const s=[...e];s.splice(n,1),t(s)})(r),type:"button","aria-label":"Remove entry",children:"\xd7"})]},r)))})]})}function v({memory:e,onChange:t}){return(0,s.jsxs)("div",{className:"state-editor-section",children:[(0,s.jsx)("div",{className:"state-editor-header",children:(0,s.jsx)("span",{children:"Memory"})}),(0,s.jsx)("textarea",{className:"state-editor-textarea",value:e||"",onChange:e=>t(e.target.value),placeholder:"0x... (hex bytes)",rows:3})]})}function y({showPointerInput:e=!0,showStateEditor:t=!0,showControls:n=!0,showFullValues:a=!1}){const{pointer:i,stateSpec:o,isResolving:l,result:d,error:u,setPointer:h,updateStateSpec:g,resolve:y}=c(),[b,j]=(0,r.useState)(i?JSON.stringify(i,null,2):""),[w,N]=(0,r.useState)(null),k=(0,r.useCallback)((e=>{if(j(e),N(null),e.trim())try{const t=JSON.parse(e);h(t)}catch(t){N(t instanceof Error?t.message:"Invalid JSON")}else h(null)}),[h]);return(0,s.jsxs)("div",{className:"resolution-visualizer",children:[(0,s.jsxs)("div",{className:"resolution-visualizer-inputs",children:[e&&(0,s.jsxs)("div",{className:"resolution-visualizer-panel pointer-panel",children:[(0,s.jsx)("h4",{className:"panel-title",children:"Pointer Definition"}),(0,s.jsx)("textarea",{className:"pointer-input",value:b,onChange:e=>k(e.target.value),placeholder:'{"location": "storage", "slot": 0}',rows:10}),w&&(0,s.jsx)("div",{className:"pointer-parse-error",children:w})]}),t&&(0,s.jsxs)("div",{className:"resolution-visualizer-panel state-panel",children:[(0,s.jsx)("h4",{className:"panel-title",children:"Machine State"}),(0,s.jsxs)("div",{className:"state-editor",children:[(0,s.jsx)(f,{storage:o.storage||{},onChange:e=>g("storage",e)}),(0,s.jsx)(x,{stack:o.stack||[],onChange:e=>g("stack",e)}),(0,s.jsx)(v,{memory:o.memory,onChange:e=>g("memory",e)})]})]})]}),n&&(0,s.jsx)("div",{className:"resolution-visualizer-controls",children:(0,s.jsx)("button",{className:"resolve-button",onClick:()=>y(),disabled:l||!i,type:"button",children:l?"Resolving...":"Resolve Pointer"})}),(0,s.jsxs)("div",{className:"resolution-visualizer-output",children:[u&&(0,s.jsxs)("div",{className:"resolution-error",children:[(0,s.jsx)("h4",{children:"Resolution Error"}),(0,s.jsx)("pre",{children:u.message})]}),d&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("div",{className:"resolution-visualizer-panel regions-panel",children:[(0,s.jsx)("h4",{className:"panel-title",children:"Named Regions"}),(0,s.jsx)(m,{regions:d.namedRegions})]}),(0,s.jsxs)("div",{className:"resolution-visualizer-panel output-panel",children:[(0,s.jsx)("h4",{className:"panel-title",children:"Resolved Output"}),(0,s.jsx)(p,{regions:d.regions,values:d.values,showFullValues:a})]})]})]})]})}var b=n(49499);const j=(0,r.createContext)(null);function w({children:e,initialPointer:t=null,initialState:n={},initialOpen:a=!1}){const[i,o]=(0,r.useState)(t),[l,c]=(0,r.useState)(n),[d,u]=(0,r.useState)(a),h=(0,r.useCallback)((()=>u(!0)),[]),m=(0,r.useCallback)((()=>u(!1)),[]),g=(0,r.useCallback)((()=>u((e=>!e))),[]),p=(0,r.useCallback)(((e,t={})=>{o(e),c(t),u(!0)}),[]);return(0,s.jsx)(j.Provider,{value:{pointer:i,stateSpec:l,isOpen:d,loadExample:p,openDrawer:h,closeDrawer:m,toggleDrawer:g,setPointer:o,setStateSpec:c},children:e})}function N(){return(0,s.jsx)(b.A,{fallback:null,children:()=>(0,s.jsx)(k,{})})}function k(){const{pointer:e,stateSpec:t,isOpen:n,toggleDrawer:a,closeDrawer:i}=function(){const e=(0,r.useContext)(j);if(!e)throw new Error("usePointerPlayground must be used within a PointerPlaygroundProvider");return e}(),[o,l]=(0,r.useState)((()=>Math.round(.4*window.innerHeight))),[c,u]=(0,r.useState)(!1),h=(0,r.useRef)(null),[m,g]=(0,r.useState)(0);(0,r.useEffect)((()=>{g((e=>e+1))}),[e,t]);const p=(0,r.useCallback)((e=>{e.preventDefault(),u(!0)}),[]);return(0,r.useEffect)((()=>{if(!c)return;const e=e=>{const t="touches"in e?e.touches[0].clientY:e.clientY,n=window.innerHeight,s=n-t,r=.85*n;l(Math.max(200,Math.min(s,r)))},t=()=>{u(!1)};return document.addEventListener("mousemove",e),document.addEventListener("mouseup",t),document.addEventListener("touchmove",e),document.addEventListener("touchend",t),()=>{document.removeEventListener("mousemove",e),document.removeEventListener("mouseup",t),document.removeEventListener("touchmove",e),document.removeEventListener("touchend",t)}}),[c]),(0,r.useEffect)((()=>{const e=e=>{"Escape"===e.key&&n&&i()};return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)}),[n,i]),n?(0,s.jsxs)("div",{ref:h,className:"pointer-drawer open "+(c?"resizing":""),style:{"--drawer-height":`${o}px`},children:[(0,s.jsx)("div",{className:"pointer-drawer-resize-handle",onMouseDown:p,onTouchStart:p,children:(0,s.jsx)("div",{className:"resize-handle-bar"})}),(0,s.jsxs)(d,{initialPointer:e,initialStateSpec:t,autoResolve:!0,children:[(0,s.jsx)(S,{toggleDrawer:a,closeDrawer:i}),(0,s.jsx)("div",{className:"pointer-drawer-content",children:(0,s.jsx)(y,{showPointerInput:!0,showStateEditor:!0,showControls:!1,showFullValues:!1})})]},m)]}):(0,s.jsx)("div",{ref:h,className:"pointer-drawer closed",style:{"--drawer-height":`${o}px`},children:(0,s.jsx)("div",{className:"pointer-drawer-header",children:(0,s.jsxs)("button",{className:"pointer-drawer-toggle",onClick:a,type:"button","aria-expanded":!1,"aria-label":"Open pointer playground",children:[(0,s.jsx)("span",{className:"toggle-icon",children:"\u25b2"}),(0,s.jsx)("span",{className:"toggle-text",children:"Pointer Playground"})]})})})}function S({toggleDrawer:e,closeDrawer:t}){const{pointer:n,isResolving:r,resolve:a}=c();return(0,s.jsxs)("div",{className:"pointer-drawer-header",children:[(0,s.jsxs)("button",{className:"pointer-drawer-toggle",onClick:e,type:"button","aria-expanded":!0,"aria-label":"Close pointer playground",children:[(0,s.jsx)("span",{className:"toggle-icon",children:"\u25bc"}),(0,s.jsx)("span",{className:"toggle-text",children:"Pointer Playground"})]}),(0,s.jsxs)("div",{className:"pointer-drawer-header-actions",children:[(0,s.jsx)("button",{className:"resolve-button",onClick:()=>a(),disabled:r||!n,type:"button",children:r?"Resolving...":"Resolve Pointer"}),(0,s.jsx)("button",{className:"pointer-drawer-close",onClick:t,type:"button","aria-label":"Close",children:"\u2715"})]})]})}var C=n(54034),E=n.n(C);function P({pointer:e,state:t={},title:n,description:r,showCode:a=!0}){const i=JSON.stringify(e,null,2);return(0,s.jsxs)("div",{className:"pointer-example",children:[n&&(0,s.jsx)("div",{className:"pointer-example-title",children:n}),r&&(0,s.jsx)("div",{className:"pointer-example-description",children:r}),(0,s.jsxs)("div",{className:"pointer-example-content",children:[a&&(0,s.jsx)(E(),{language:"json",className:"pointer-example-code",children:i}),(0,s.jsx)(b.A,{fallback:null,children:()=>(0,s.jsx)(R,{pointer:e,state:t,showCode:a})})]})]})}function R({pointer:e,state:t,showCode:n}){const a=(0,r.useContext)(j);if(!a)return null;return(0,s.jsxs)("button",{className:"pointer-example-try-btn "+(n?"":"standalone"),onClick:()=>{a.loadExample(e,t)},type:"button",title:"Load this example in the Pointer Playground",children:[(0,s.jsx)("span",{className:"try-btn-icon",children:"\u25b6"}),(0,s.jsx)("span",{className:"try-btn-text",children:"Try it"})]})}function U({children:e,initialPointer:t,initialState:n}){return(0,s.jsx)(b.A,{fallback:(0,s.jsx)("div",{className:"pointer-playground-fallback",children:e}),children:()=>(0,s.jsxs)(w,{initialPointer:t??null,initialState:n,initialOpen:!1,children:[(0,s.jsx)("div",{className:"pointer-playground-content",children:e}),(0,s.jsx)(N,{})]})})}},70396(e,t,n){var s;n.d(t,{B:()=>o,D:()=>g}),function(e){e.dereferencePointer=e=>({kind:"dereference-pointer",pointer:e}),e.saveRegions=e=>({kind:"save-regions",regions:e}),e.saveVariables=e=>({kind:"save-variables",variables:e}),e.pushRegionRenames=e=>({kind:"push-region-renames",mapping:e}),e.popRegionRenames=()=>({kind:"pop-region-renames"}),e.pushTemplates=e=>({kind:"push-templates",templates:e}),e.popTemplates=()=>({kind:"pop-templates"})}(s||(s={}));var r=n(31917),a=n(43568);const i=Symbol.for("nodejs.util.inspect.custom");class o extends Uint8Array{static zero(){return new o([])}static fromUint(e){if(0n===e)return this.zero();const t=Math.ceil(Number(e.toString(2).length)/8),n=new Uint8Array(t);for(let s=t-1;s>=0;s--)n[s]=Number(0xffn&e),e>>=8n;return new o(n)}static fromNumber(e){const t=Math.ceil(Math.log2(e+1)/8),n=new Uint8Array(t);for(let s=t-1;s>=0;s--)n[s]=255&e,e>>=8;return new o(n)}static fromHex(e){if(!e.startsWith("0x"))throw new Error('Invalid hex string format. Expected "0x" prefix.');const t=new Uint8Array((e.length-2)/2+.5);for(let n=2;n<e.length;n+=2)t[n/2-1]=parseInt(e.slice(n,n+2),16);return new o(t)}static fromBytes(e){return new o(e)}asUint(){const e=8n;let t=0n;for(const n of this.values()){t=(t<<e)+BigInt(n)}return t}toHex(){return`0x${(0,a.nj)(this)}`}padUntilAtLeast(e){if(this.length>=e)return this;const t=new Uint8Array(e);return t.set(this,e-this.length),o.fromBytes(t)}resizeTo(e){if(this.length===e)return this;const t=new Uint8Array(e);return this.length<e?t.set(this,e-this.length):t.set(this.slice(this.length-e)),o.fromBytes(t)}concat(...e){const t=[this,...e].map((e=>e.toHex().slice(2))).reduce(((e,t)=>`${e}${t}`),"0x");return o.fromHex(t)}inspect(e,t,n){return`Data[${t.stylize(this.toHex(),"number")}]`}[i](e,t,n){return this.inspect(e,t,n)}}async function l(e,t){const{location:n}=e,{state:s}=t;switch(n){case"stack":{const{slot:t,offset:n=0n,length:r=32n}=c(["slot","offset","length"],e);return await s.stack.peek({depth:t,slice:{offset:n,length:r}})}case"memory":{const{offset:t,length:n}=c(["offset","length"],e);return await s.memory.read({slice:{offset:t,length:n}})}case"storage":{const{slot:t}=e,{offset:n=0n,length:r=32n}=c(["offset","length"],e);return await s.storage.read({slot:t,slice:{offset:n,length:r}})}case"calldata":{const{offset:t,length:n}=c(["offset","length"],e);return await s.calldata.read({slice:{offset:t,length:n}})}case"returndata":{const{offset:t,length:n}=c(["offset","length"],e);return await s.returndata.read({slice:{offset:t,length:n}})}case"transient":{const{slot:t}=e,{offset:n=0n,length:r=32n}=c(["offset","length"],e);return await s.transient.read({slot:t,slice:{offset:n,length:r}})}case"code":{const{offset:t,length:n}=c(["offset","length"],e);return await s.code.read({slice:{offset:t,length:n}})}}}function c(e,t){const n={};for(const s of e){const e=t[s];void 0!==e&&(n[s]=e.asUint())}return n}var d=n(33688);async function u(e,t){if(r.gm.Expression.isLiteral(e))return async function(e){switch(typeof e){case"string":return o.fromHex(e);case"number":return o.fromNumber(e)}}(e);if(r.gm.Expression.isConstant(e))return async function(e){if("$wordsize"===e)return o.fromHex("0x20")}(e);if(r.gm.Expression.isVariable(e))return async function(e,{variables:t}){const n=t[e];if(void 0===n)throw new Error(`Unknown variable with identifier ${e}`);return n}(e,t);if(r.gm.Expression.isArithmetic(e)){if(r.gm.Expression.Arithmetic.isSum(e))return async function(e,t){const n=await Promise.all(e.$sum.map((async e=>await u(e,t)))),s=n.reduce(((e,{length:t})=>t>e?t:e),0);return o.fromUint(n.reduce(((e,t)=>e+t.asUint()),0n)).padUntilAtLeast(s)}(e,t);if(r.gm.Expression.Arithmetic.isDifference(e))return async function(e,t){const[n,s]=await Promise.all(e.$difference.map((async e=>await u(e,t)))),r=n.length>s.length?n.length:s.length,a=n.asUint()>s.asUint()?o.fromUint(n.asUint()-s.asUint()):o.fromNumber(0);return a.padUntilAtLeast(r)}(e,t);if(r.gm.Expression.Arithmetic.isProduct(e))return async function(e,t){const n=await Promise.all(e.$product.map((async e=>await u(e,t)))),s=n.reduce(((e,{length:t})=>t>e?t:e),0);return o.fromUint(n.reduce(((e,t)=>e*t.asUint()),1n)).padUntilAtLeast(s)}(e,t);if(r.gm.Expression.Arithmetic.isQuotient(e))return async function(e,t){const[n,s]=await Promise.all(e.$quotient.map((async e=>await u(e,t)))),r=n.length>s.length?n.length:s.length;return o.fromUint(n.asUint()/s.asUint()).padUntilAtLeast(r)}(e,t);if(r.gm.Expression.Arithmetic.isRemainder(e))return async function(e,t){const[n,s]=await Promise.all(e.$remainder.map((async e=>await u(e,t)))),r=n.length>s.length?n.length:s.length;return o.fromUint(n.asUint()%s.asUint()).padUntilAtLeast(r)}(e,t)}if(r.gm.Expression.isKeccak256(e))return async function(e,t){const n=await Promise.all(e.$keccak256.map((async e=>await u(e,t)))),s=o.zero().concat(...n);return o.fromBytes((0,d.So)(s))}(e,t);if(r.gm.Expression.isConcat(e))return async function(e,t){const n=await Promise.all(e.$concat.map((async e=>await u(e,t))));return o.zero().concat(...n)}(e,t);if(r.gm.Expression.isResize(e))return async function(e,t){const[[n,s]]=Object.entries(e),a=r.gm.Expression.Resize.isToNumber(e)?Number(n.match(/^\$sized([1-9]+[0-9]*)$/)[1]):32;return(await u(s,t)).resizeTo(a)}(e,t);if(r.gm.Expression.isLookup(e)){if(r.gm.Expression.Lookup.isOffset(e))return h(".offset",e,t);if(r.gm.Expression.Lookup.isLength(e))return h(".length",e,t);if(r.gm.Expression.Lookup.isSlot(e))return h(".slot",e,t)}if(r.gm.Expression.isRead(e))return async function(e,t){const{state:n,regions:s}=t,r=e.$read,a=s[r];if(!a)throw new Error(`Region not found: ${r}`);return await l(a,t)}(e,t);throw new Error(`Unexpected runtime failure to recognize kind of expression: ${JSON.stringify(e)}`)}async function h(e,t,n){const{regions:s}=n,a=t[e],i=s[a];if(!i)throw new Error(`Region not found: ${a}`);const o=r.gm.Expression.Lookup.propertyFrom(e),l=i[o];if(void 0===l)throw new Error(`Region named ${a} does not have ${o} needed by lookup`);return l}async function*m(e,t){if(r.gm.isRegion(e)){const n=e;return yield*async function*(e,{stackLengthChange:t,...n}){const a=await async function(e,t){const n={},s={},r=new Proxy({...e},{get(e,t){if(t in n)return n[t];throw new Error(`Property not evaluated yet: $this.${t.toString()}`)}}),a=["slot","offset","length"],i=a.filter((t=>t in e)).map((t=>[t,e[t]]));for(;i.length>0;){const[e,l]=i.shift();try{const s=await u(l,{...t,regions:{...t.regions,$this:r}});n[e]=s}catch(o){if(!(o instanceof Error&&o.message.startsWith("Property not evaluated yet: $this.")))throw o;{const t=s[e]||0;if(t>a.length-1)throw new Error(`Circular reference detected: $this.${e.toString()}`);s[e]=t+1,i.push([e,l])}}}return{...e,...n}}(function(e,t){if(r.gm.Region.isStack(e)){const n=0n===t?e.slot:t>0n?{$sum:[e.slot,`0x${t.toString(16)}`]}:{$difference:[e.slot,"0x"+-t.toString(16)]};return{...e,slot:n}}return e}(e,t),n);if(yield a,void 0!==e.name)return[s.saveRegions({[e.name]:a})];return[]}(n,t)}const n=e;if(r.gm.Collection.isGroup(n))return yield*async function*(e,t){const{group:n}=e;return n.map(s.dereferencePointer)}(n);if(r.gm.Collection.isList(n))return yield*async function*(e,t){const{list:n}=e,{count:r,each:a,is:i}=n,l=(await u(r,t)).asUint(),c=[];for(let d=0n;d<l;d++)c.push(s.saveVariables({[a]:o.fromUint(d)})),c.push(s.dereferencePointer(i));return c}(n,t);if(r.gm.Collection.isConditional(n))return yield*async function*(e,t){const{if:n,then:r,else:a}=e,i=(await u(n,t)).asUint();if(i)return[s.dereferencePointer(r)];return a?[s.dereferencePointer(a)]:[]}(n,t);if(r.gm.Collection.isScope(n))return yield*async function*(e,t){const{define:n,in:r}=e,a={...t.variables},i={};for(const[s,o]of Object.entries(n)){const e=await u(o,{...t,variables:a});a[s]=e,i[s]=e}return[s.saveVariables(i),s.dereferencePointer(r)]}(n,t);if(r.gm.Collection.isReference(n))return yield*async function*(e,t){const{template:n,yields:r}=e,{templates:a,variables:i}=t,o=a[n];if(!o)throw new Error(`Unknown pointer template named ${n}`);const{expect:l,for:c}=o,d=new Set(Object.keys(i)),u=l.filter((e=>!d.has(e)));if(u.length>0)throw new Error([`Invalid reference to template named ${n}; missing expected `,`variables with identifiers: ${u.join(", ")}. `,"Please ensure these variables are defined prior to this reference."].join(""));if(r&&Object.keys(r).length>0)return[s.pushRegionRenames(r),s.dereferencePointer(c),s.popRegionRenames()];return[s.dereferencePointer(c)]}(n,t);if(r.gm.Collection.isTemplates(n))return yield*async function*(e,t){const{templates:n,in:r}=e;return[s.pushTemplates(n),s.dereferencePointer(r),s.popTemplates()]}(n);throw console.error("%s",JSON.stringify(e,void 0,2)),new Error("Unexpected unknown kind of pointer")}async function g(e,t={}){const n=await async function({templates:e={},state:t}){const n=t?await t.stack.length:0n;return{templates:e,initialStackLength:n}}(t);return function(e){return{async view(t){const n=[];for await(const o of e(t))n.push(o);const s={},r={},a={writable:!1,enumerable:!1,configurable:!1},i=Object.create(Array.prototype,{length:{value:n.length,...a}});for(const[e,o]of n.entries())Object.defineProperty(i,e,{value:o,...a,enumerable:!0}),"string"==typeof o.name&&(o.name in s||(s[o.name]=[]),s[o.name].push(o),r[o.name]=o);for(const[e,o]of Object.entries(r))Object.defineProperty(i,e,{value:o,...a});return Object.defineProperties(i,{named:{value:e=>s[e]||[],...a},lookup:{value:{...r},...a}}),{regions:i,read:async e=>await l(e,{state:t})}}}}((t=>({async*[Symbol.asyncIterator](){yield*async function*(e,t){const n=await async function({templates:e,state:t,initialStackLength:n}){return{templates:e,state:t,stackLengthChange:await t.stack.length-n,regions:{},variables:{}}}(t),{regions:r,variables:a}=n,i=[],o=[],l=[s.dereferencePointer(e)];for(;l.length>0;){const e=l.pop();let t=[];switch(e.kind){case"dereference-pointer":{const s=o.reduce(((e,t)=>({...e,...t})),n.templates),r=m(e.pointer,{...n,templates:s});let a=await r.next();for(;!a.done;){let e=a.value;const t=i[i.length-1];if(t&&e.name){const n=t[e.name];n&&n!==e.name&&(e={...e,name:n})}yield e,a=await r.next()}t=a.value;break}case"save-regions":for(const[t,n]of Object.entries(e.regions))r[t]=n;break;case"save-variables":Object.assign(a,e.variables);break;case"push-region-renames":i.push(e.mapping);break;case"pop-region-renames":{const e=i.pop();if(e)for(const[t,n]of Object.entries(e))t in r&&n!==t&&(r[n]={...r[t],name:n});break}case"push-templates":o.push(e.templates);break;case"pop-templates":o.pop()}for(let n=t.length-1;n>=0;n--)l.push(t[n])}}(e,{...n,state:t})}})))}}}]);