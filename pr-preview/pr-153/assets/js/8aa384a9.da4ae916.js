(self.webpackChunk_ethdebug_format_web=self.webpackChunk_ethdebug_format_web||[]).push([[1583],{18290:(e,t,n)=>{"use strict";n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>c,default:()=>p,frontMatter:()=>o,metadata:()=>a,toc:()=>d});var r=n(52322),s=n(45392),i=n(61376);const o={sidebar_position:3},c="Making regions concrete",a={id:"implementation-guides/pointers/dereference-logic/making-regions-concrete",title:"Making regions concrete",description:"There are two main aspects involved when converting from a Pointer.Region,",source:"@site/docs/implementation-guides/pointers/dereference-logic/making-regions-concrete.mdx",sourceDirName:"implementation-guides/pointers/dereference-logic",slug:"/implementation-guides/pointers/dereference-logic/making-regions-concrete",permalink:"/format/pr-preview/pr-153/docs/implementation-guides/pointers/dereference-logic/making-regions-concrete",draft:!1,unlisted:!1,editUrl:"https://github.com/ethdebug/format/tree/main/packages/web/docs/implementation-guides/pointers/dereference-logic/making-regions-concrete.mdx",tags:[],version:"current",sidebarPosition:3,frontMatter:{sidebar_position:3},sidebar:"docsSidebar",previous:{title:"Generating regions on the fly",permalink:"/format/pr-preview/pr-153/docs/implementation-guides/pointers/dereference-logic/generating-regions"},next:{title:"End-to-end testing",permalink:"/format/pr-preview/pr-153/docs/implementation-guides/pointers/testing/"}},l={},d=[{value:"Fixing stack-located regions&#39; <code>slot</code> offset",id:"fixing-stack-located-regions-slot-offset",level:2},{value:"Evaluating region property expressions",id:"evaluating-region-property-expressions",level:2}];function h(e){const t={code:"code",h1:"h1",h2:"h2",p:"p",pre:"pre",strong:"strong",...(0,s.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.h1,{id:"making-regions-concrete",children:"Making regions concrete"}),"\n",(0,r.jsxs)(t.p,{children:["There are two main aspects involved when converting from a ",(0,r.jsx)(t.code,{children:"Pointer.Region"}),",\nwhich is full of properties whose values are the dynamic ",(0,r.jsx)(t.code,{children:"Pointer.Expression"}),"\nobjects, into a ",(0,r.jsx)(t.code,{children:"Cursor.Region"}),", whose expression properties have been replaced\nwith actual bytes ",(0,r.jsx)(t.code,{children:"Data"}),":"]}),"\n",(0,r.jsxs)(t.h2,{id:"fixing-stack-located-regions-slot-offset",children:["Fixing stack-located regions' ",(0,r.jsx)(t.code,{children:"slot"})," offset"]}),"\n",(0,r.jsx)(t.p,{children:"Since stack pointers are expected to be declared at one time yet evaluated\nlater, the relative offset that stack pointers use must be adjusted based on\nthe initial stack length vs. the current stack length."}),"\n",(0,r.jsxs)(t.p,{children:["This behavior is encapsulated by the ",(0,r.jsx)(t.code,{children:"adjustStackLength"})," function:"]}),"\n",(0,r.jsx)(i.Z,{packageName:"@ethdebug/pointers",sourcePath:"src/dereference/region.ts",extract:e=>e.getFunction("adjustStackLength")}),"\n",(0,r.jsx)(t.h2,{id:"evaluating-region-property-expressions",children:"Evaluating region property expressions"}),"\n",(0,r.jsxs)(t.p,{children:["The more substantial aspect of making a region concrete, however, is the\nprocess by which this implementation evaluates each of the ",(0,r.jsx)(t.code,{children:"Pointer.Region"}),"'s\nexpression properties and converts them into their ",(0,r.jsx)(t.code,{children:"Data"})," values."]}),"\n",(0,r.jsxs)(t.p,{children:["This process would be very straightforward, except that pointer expressions\nmay reference the region in which they are specified by use of the special\nregion identifier ",(0,r.jsx)(t.code,{children:'"$this"'}),"."]}),"\n",(0,r.jsx)(t.p,{children:"Fortunately, the schema does not allow any kind of circular reference, so a\nmore robust implementation could pre-process a region's properties to detect\ncycles and determine the evaluation order for each property based on which\nproperty references which other property. That is, a robust implementation\nmight take this pointer:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-json",children:'{\n  "location": "memory",\n  "offset": {\n    "$sum": [\n      0x60,\n      { ".length": "$this" }\n    ]\n  },\n  "length": "$wordsize"\n}\n'})}),"\n",(0,r.jsxs)(t.p,{children:["... and detect that it must evaluate ",(0,r.jsx)(t.code,{children:"length"})," before evaluating ",(0,r.jsx)(t.code,{children:"offset"}),"."]}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.strong,{children:"@ethdebug/pointers"})," reference implementation ",(0,r.jsx)(t.strong,{children:"does not do any such\nsmart thing"}),". Instead, it pushes each of the three possible expression\nproperties (",(0,r.jsx)(t.code,{children:'"slot"'}),", ",(0,r.jsx)(t.code,{children:'"offset"'}),", and ",(0,r.jsx)(t.code,{children:'"length"'}),") into a queue, and then\nproceeds to evaluate properties from the queue one at a time."]}),"\n",(0,r.jsxs)(t.p,{children:["When evaluating a particular property, if ",(0,r.jsx)(t.code,{children:"evaluate()"})," fails, it adds this\nproperty to the end of the queue to try again later, counting the number of\ntimes this attempt has been made for this property. Because the number of\nproperties is at most 3, if the number of attempts ever reaches 3, the\nimplementation can infer that there must be a circular reference."]}),"\n",(0,r.jsx)(i.Z,{packageName:"@ethdebug/pointers",sourcePath:"src/dereference/region.ts",extract:e=>e.getFunction("evaluateRegion")})]})}function p(e={}){const{wrapper:t}={...(0,s.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(h,{...e})}):h(e)}},48313:e=>{function t(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=48313,e.exports=t},61376:(e,t,n)=>{"use strict";n.d(t,{Z:()=>g});var r=n(84560),s=n.n(r),i=n(20477),o=n(42408);var c=n(2784),a=n(27718),l=n(52322);function d(e){let{code:t,links:n,...r}=e;const i=(0,c.useRef)(null),[o,a]=(0,c.useState)(null);return(0,c.useEffect)((()=>{function e(){if(i.current){const e=i.current.querySelector("pre > code");if(e){const t=Array.from(e.childNodes).flatMap((e=>h(e,n)));a((0,l.jsx)("pre",{className:e.parentElement?.className,children:(0,l.jsx)("code",{className:e.className,children:t})}))}}}e();const t=new MutationObserver(e);return i.current&&t.observe(i.current,{childList:!0,subtree:!0}),()=>t.disconnect()}),[t,n]),o||(0,l.jsx)("div",{ref:i,children:(0,l.jsx)(s(),{...r,children:t})})}function h(e,t){return e.nodeType===Node.TEXT_NODE?function(e,t){const n=[];let r=e.textContent||"",s=0;for(const[i,o]of Object.entries(t)){let e=r.indexOf(i,s);for(;-1!==e;)e>s&&n.push(r.slice(s,e)),n.push((0,l.jsx)(a.Z,{to:o,className:"linked-code-block-link",children:i},`${i}-${e}`)),s=e+i.length,e=r.indexOf(i,s)}s<r.length&&n.push(r.slice(s));return n}(e,t):e.nodeType===Node.ELEMENT_NODE?function(e,t){const n=e.tagName.toLowerCase(),r={key:p++,className:e.className};e.style&&e.style.cssText&&(r.style=function(e){const t={};for(const n of e.split(";"))if(n){const[e,r]=n.split(":");if(e&&r){t[e.trim().replace(/-./g,(e=>e[1].toUpperCase()))]=r.trim()}}return t}(e.style.cssText));if(u.has(n))return c.createElement(n,r);const s=Array.from(e.childNodes).flatMap((e=>h(e,t)));return c.createElement(n,r,s)}(e,t):[]}let p=0;const u=new Set(["area","base","br","col","embed","hr","img","input","link","meta","param","source","track","wbr"]);function g(e){let{packageName:t,sourcePath:n,includePackageNameInTitle:r=!1,extract:c,links:a={},...h}=e;const p=function(e){const{packages:t}=(0,o.eZ)("project-code-plugin");if(!(e in t))throw new Error(`Unknown package name ${e}`);const{sourceFiles:n}=t[e],r=new i.IKL({useInMemoryFileSystem:!0});for(const{filePath:s,text:i}of n)r.createSourceFile(s,i,{overwrite:!0});return r}(t),u=p.getSourceFileOrThrow(n),g=c?c(u,p):u,m=g.getFullText().trim(),f=!c,x=r?(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("strong",{children:t})," ",n]}):n;return Object.keys(a).length>0?(0,l.jsx)(d,{code:m,links:a,language:"typescript",...h}):(0,l.jsx)(s(),{language:"typescript",...f?{title:x,showLineNumbers:!0}:{showLineNumbers:!1},...h,children:g.getFullText().trim()})}},56699:()=>{},68379:()=>{},68382:()=>{},78867:()=>{},21212:()=>{},89854:()=>{},25800:()=>{},93037:()=>{},26996:()=>{}}]);