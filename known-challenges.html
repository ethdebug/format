<!doctype html>
<html class="no-js" lang="en">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="Schema" href="schema.html" /><link rel="prev" title="Overview" href="overview.html" />

    <meta name="generator" content="sphinx-5.3.0, furo 2022.09.29"/>
        <title>Known challenges - Ethereum Debugging Data Format documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?digest=d81277517bee4d6b0349d71bb2661d4890b5617c" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?digest=30d1aed668e5c3a91c3e3bf6a60b675221979f0e" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Ethereum Debugging Data Format  documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">Ethereum Debugging Data Format  documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Known challenges</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">Schema</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="known-challenges">
<h1>Known challenges<a class="headerlink" href="#known-challenges" title="Permalink to this heading">#</a></h1>
<p>The fundamental challenge for an Ethereum debugging data format is that, on the
one hand, we want it to be able to handle the complexity of Solidity and other
existing EVM languages; but also, we wish to handle these in a suitably general
manner rather than simply assuming this complexity, so that it may handle other
languages in the future; but also, we want to keep down the complexity of the
format itself if possible.</p>
<p>In what follows we’ll outline some particular thorns of the EVM in general and
Solidity and Vyper in particular that will have to be addressed.  This is not
necessarily a complete list.</p>
<section id="different-data-formats-per-location">
<h2>Different data formats per location<a class="headerlink" href="#different-data-formats-per-location" title="Permalink to this heading">#</a></h2>
<p>Any debugging data format will need to handle the fact that in both Solidity and
in Vyper the same type can have different representations depending on which
location (the stack, memory, storage, calldata, or code) it is stored in.  As
such it does not suffice to give a single representation for a single type, but
rather, it may be necessary to specify multiple representations, corresponding
to the different data locations.</p>
</section>
<section id="the-word-based-nature-of-storage-and-the-stack">
<h2>The word-based nature of storage and the stack<a class="headerlink" href="#the-word-based-nature-of-storage-and-the-stack" title="Permalink to this heading">#</a></h2>
<p>Of the data locations mentioned above, most are byte-based, but two, the stack
and storage, are word-based.  This will likely necessitate slightly different
handling for them.</p>
<p>Moreover, the fact that these two locations are word-based means there can be a
need to specify endianness.  For instance, in Solidity, arrays may pack multiple
elements into the same storage word, starting from the low byte.  However,
segments of strings in storage start at the high byte of their word.  So it will
be necessary to have a way to specify this.  (In particular, consider the case
of a <code class="docutils literal notranslate"><span class="pre">bytes2[]</span> <span class="pre">storage</span></code>; each <code class="docutils literal notranslate"><span class="pre">bytes2</span></code> is packed into the word in a
little-endian order, but each <code class="docutils literal notranslate"><span class="pre">bytes2</span></code> itself is stord in a big-endian order.)</p>
<p>(Of course, there can also be a need to specify endianness in byte-based
locations, e.g. for storage of integers.  Currently all EVM languages known to
me do this in a big-endian fashion, because this is what the EVM makes
convenient.  It may be OK to assume that integers are big-endian, but the
reverse possibility is at least worth noting.)</p>
</section>
<section id="complex-stride-patterns">
<h2>Complex stride patterns<a class="headerlink" href="#complex-stride-patterns" title="Permalink to this heading">#</a></h2>
<p>In most languages, elements of an array are stored consecutively to one another.
However, this is not always the case, and so the DWARF debugging data format
allows one to distinguish between the lengths of the array elements and the
lengths of the array stride; this allows one to handle, say, the case of an
array whose elements are 2 bytes long but which each only begin on 8-byte
boundaries.</p>
<p>However, this simple notion of stride length is not sufficient for handling
Solidity’s storage arrays, whose stride patterns can be more complex.  Solidity
allows for multiple elements in an array to be packed into a word, without
filling the whole word.  If we for a moment ignore the word-based nature of
storage and instead think of it as byte-based in a little-endian fashion,
Solidity allows for patterns like “15 bytes for one element, 15 bytes for the
next element, 2 bytes of empty space, repeat”, which can’t be expressed with a
simple stride length.</p>
<p>As such it may be necessary to provide a way to specify more complex stride
patterns (or packing patterns, as that’s really what these are).</p>
</section>
<section id="the-use-of-hash-based-locations">
<h2>The use of hash-based locations<a class="headerlink" href="#the-use-of-hash-based-locations" title="Permalink to this heading">#</a></h2>
<p>Storage slots in both Solidity and Vyper are often assigned based on the Keccak
hash of various things; e.g., in a dynamically-sized array in Solidity, if the
length is stored at a slot <code class="docutils literal notranslate"><span class="pre">p</span></code>, the elements are stored beginning at
<code class="docutils literal notranslate"><span class="pre">keccak(p)</span></code>.</p>
<p>The format needs some way to be able to specify this.  This also raises the
question of whether we should allow for other hash functions.  Other hash
functions are unlikely to be used due to the EVM making keccak much more
convenient than other hashes, but it may not be the only possibility as there
are precompiles for both SHA-256 and RIPEMD-160.</p>
</section>
<section id="solidity-s-two-case-string-storage">
<h2>Solidity’s two-case string storage<a class="headerlink" href="#solidity-s-two-case-string-storage" title="Permalink to this heading">#</a></h2>
<p>Solidity, when storing strings in storage, uses a two-case format, with one case
for if it’s 31 bytes or shorter, and another case for 32 bytes or longer.</p>
<p>In order to handle this, it may be necessary to have a notion of union
representations, somewhat similar to the notion of union types?</p>
</section>
<section id="mappings">
<h2>Mappings<a class="headerlink" href="#mappings" title="Permalink to this heading">#</a></h2>
<p>Both Solidity and Vyper use mappings, and while these work similarly in both
languages, the two aren’t the same.  It will necessary to handle both styles,
and ideally other potential styles as well.</p>
<p>In both languages, given a mapping at position <code class="docutils literal notranslate"><span class="pre">p</span></code> and a key <code class="docutils literal notranslate"><span class="pre">k</span></code>, the value
corresponding to <code class="docutils literal notranslate"><span class="pre">k</span></code> is stored at a location determined by the Keccak hash of a
combination of <code class="docutils literal notranslate"><span class="pre">p</span></code> and <code class="docutils literal notranslate"><span class="pre">k</span></code>.  But the details differ both by the language, and
whether we are looking at a value type that fits into a word, or whether we are
looking at a string or bytestring.</p>
<p>Solidity always performs the computation <code class="docutils literal notranslate"><span class="pre">keccak(k.p)</span></code>, where the <code class="docutils literal notranslate"><span class="pre">.</span></code> represents
concatenation.  However, for value types the key is padded to a full word, while
for a string or bytestring, no padding is used.</p>
<p>Vyper is similar, but differs in two ways.  For value types, the computation is
instead <code class="docutils literal notranslate"><span class="pre">keccak(p.k)</span></code>, with the concatenands in the other order; note that <code class="docutils literal notranslate"><span class="pre">k</span></code>
is still padded.  Meanwhile, for strings and bytestrings, the computation is
instead <code class="docutils literal notranslate"><span class="pre">keccak(p.keccak(k))</span></code> (again with no padding on <code class="docutils literal notranslate"><span class="pre">k</span></code>).  There will need
to be a way to specify this additional complexity.</p>
</section>
<section id="markings-for-mapping-keys">
<h2>Markings for mapping keys<a class="headerlink" href="#markings-for-mapping-keys" title="Permalink to this heading">#</a></h2>
<p>The problem of keeping track of mapping keys is worth discussing separately.</p>
<p>Mappings do not keep track of their keys; as such, it is up to the debugger to
keep track of mapping keys touched in a given transaction.  This will require
some kind of markings.</p>
<p>Truffle Debugger currently handles this by using the AST and determining what
value on the stack corresponds to the key specified for a given mapping access.
However, this process is complex and requires several workarounds for unusual
cases.  While presumably markings could be devised that allow this process to
work in more generality, it’s not clear that it’s actually a good solution.</p>
<p>An alternate approach, suggested some time ago by Nomic Labs, would be to have
markings applied to the SHA3 instructions that hash key/slot combinations.
However, in the case of Vyper, for strings and bytestrings, one would presumably
also need to separately (and differently) mark the SHA3 instruction where the
string or bytestring is pre-hashed, prior to the main hashing.</p>
</section>
<section id="the-use-of-pointers-in-or-to-calldata">
<h2>The use of pointers in or to calldata<a class="headerlink" href="#the-use-of-pointers-in-or-to-calldata" title="Permalink to this heading">#</a></h2>
<p>In Solidity’s ABI encoding format (used also by Vyper), which is necessarily
used for variables stored in calldata, pointers are relative.  However, they are
not relative to their own location, but rather relative to the start of the
structure containing them.  There will need to be some way to handle this.</p>
<p>Moreover, for types in Solidity with a variable number of elements (including
strings and bytestrings), pointers on the stack to that type in calldata do not
point to the beginning of the calldata representation (which would start with
the length), but rather have both a start word and a length word, with the start
word pointing just past where the length is stored (to the beginning of the
actual contents).  It will be necessary to handle this as well.</p>
</section>
<section id="internal-function-pointers">
<h2>Internal function pointers<a class="headerlink" href="#internal-function-pointers" title="Permalink to this heading">#</a></h2>
<p>Solidity includes internal function types, which have several associated
challenges.</p>
<p>Firstly, there are two different formats for these (depending on whether or not
<code class="docutils literal notranslate"><span class="pre">viaIR</span></code> was set in compilation), so it will be necessary to handle both.</p>
<p>Secondly, the format with <code class="docutils literal notranslate"><span class="pre">viaIR</span></code> turned on relies on assigning functions
arbitrary numeric indices, so the format will have to include information
mapping indices to functions.</p>
<p>Thirdly, in the format with <code class="docutils literal notranslate"><span class="pre">viaIR</span></code> turned off, an internal function pointer
actually breaks down into one PC value for the deployed code and one PC value
for the constructor code (although the latter is not always set and is sometimes
left as zero).  So there will need to be a way to specify this complexity.</p>
<p>Moreover, an internal function pointer can point to a designated revert function
introduced by the compiler rather than defined by the user; it will be necessary
to handle this case.</p>
</section>
<section id="lack-of-fixed-variable-locations-on-the-stack">
<h2>Lack of fixed variable locations on the stack<a class="headerlink" href="#lack-of-fixed-variable-locations-on-the-stack" title="Permalink to this heading">#</a></h2>
<p>In languages that put variables on the stack, those variables may not have a
fixed location.  (For instance, Solidity with optimization turned on.)  There
will need to be a way to keep track of variables that move around on the stack.</p>
</section>
<section id="the-possibility-of-handling-other-languages">
<h2>The possibility of handling other languages<a class="headerlink" href="#the-possibility-of-handling-other-languages" title="Permalink to this heading">#</a></h2>
<p>This is something of a reiteration of the initial point, but, it would be ideal
to be able to handle features that we may expect to see in other languages even
if they do not appear in Solidity or Vyper.</p>
<p>For instance, the (now-defunct) EVM language Pyramid was (largely) dynamically
typed, making each variable effectively a sum type.  Sum types are an example of
a feature we may want to be able to handle even if is not present in either
Solidity or Vyper.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="schema.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Schema</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="overview.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Overview</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2022, g. nicholas d&#39;andrea &lt;gnidan@consensys.net&gt;, et al.
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Known challenges</a><ul>
<li><a class="reference internal" href="#different-data-formats-per-location">Different data formats per location</a></li>
<li><a class="reference internal" href="#the-word-based-nature-of-storage-and-the-stack">The word-based nature of storage and the stack</a></li>
<li><a class="reference internal" href="#complex-stride-patterns">Complex stride patterns</a></li>
<li><a class="reference internal" href="#the-use-of-hash-based-locations">The use of hash-based locations</a></li>
<li><a class="reference internal" href="#solidity-s-two-case-string-storage">Solidity’s two-case string storage</a></li>
<li><a class="reference internal" href="#mappings">Mappings</a></li>
<li><a class="reference internal" href="#markings-for-mapping-keys">Markings for mapping keys</a></li>
<li><a class="reference internal" href="#the-use-of-pointers-in-or-to-calldata">The use of pointers in or to calldata</a></li>
<li><a class="reference internal" href="#internal-function-pointers">Internal function pointers</a></li>
<li><a class="reference internal" href="#lack-of-fixed-variable-locations-on-the-stack">Lack of fixed variable locations on the stack</a></li>
<li><a class="reference internal" href="#the-possibility-of-handling-other-languages">The possibility of handling other languages</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/scripts/furo.js"></script>
    </body>
</html>